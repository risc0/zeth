use core::fmt::{Display, Formatter, Result as FmtResult};
use std::{
    ffi::{CStr, CString},
    os::raw::c_char,
};

use serde::Deserialize;
extern "C" {
    fn MptRoot(str: *const c_char) -> *const c_char;
    fn FreeString(str: *const c_char);
}

#[derive(Deserialize, Debug)]
pub struct MptResult {
    pub root: B256,
    pub rlps: Vec<String>,
}

pub fn go_mtp_root(txs: &str) -> Result<MptResult, Error> {
    // Create a string we can pass into Go
    let c_txs = CString::new(txs).expect("invalid config");

    // Generate the trace externally
    let result = unsafe { MptRoot(c_txs.as_ptr()) };

    // Convert the returned string to something we can use in Rust again.
    // Also make sure the returned data is copied to rust managed memory.
    let c_result = unsafe { CStr::from_ptr(result) };
    let result = c_result
        .to_str()
        .expect("Error translating EVM trace from library")
        .to_string();

    // We can now free the returned string (memory managed by Go)
    unsafe { FreeString(c_result.as_ptr()) };

    // Return the trace
    let result = match result.is_empty() || result.starts_with("Failed") {
        true => return Err(Error::MptRoot(result)),
        false => result,
    };
    let result: MptResult = from_str(&result).map_err(|e| Error::MptRoot(e.to_string()))?;
    Ok(result)
}

use serde_json::from_str;
use zeth_primitives::{transactions::EthereumTransaction, trie::MptNode, RlpBytes, B256};

pub fn rust_mtp_root(txs: &str) -> Result<MptResult, Error> {
    let txs = from_str::<Vec<EthereumTransaction>>(txs).unwrap();
    let mut tx_trie = MptNode::default();
    let mut rlps = vec![];
    for (tx_no, tx) in txs.iter().enumerate() {
        let tx_rlp = tx.to_rlp();
        let tx_hex = hex::encode(&tx_rlp);
        rlps.push(tx_hex);
        tx_trie.insert_rlp(&tx_no.to_rlp(), tx).unwrap();
    }
    Ok(MptResult {
        root: tx_trie.hash(),
        rlps,
    })
}

/// Error type for any geth-utils related failure.
#[derive(Debug, Clone)]
pub enum Error {
    /// Error while tracing.
    MptRoot(String),
}

impl Display for Error {
    fn fmt(&self, f: &mut Formatter<'_>) -> FmtResult {
        write!(f, "{:?}", self)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_mpt_root() {
        let txs = r#"
        [{"essence":{"Eip1559":{"chain_id":167008,"nonce":23206,"max_priority_fee_per_gas":"0x0","max_fee_per_gas":"0x1","gas_limit":"0x3d090","to":{"Call":"0x1670080000000000000000000000000000010001"},"value":"0x0","data":"0xda69d3db5e05b7df7c06a03d7b463a5374c9e8aeb9f3dc21c152f7309cac258958f6b15dd80f1a3f49e593ac3be25fa60632d332f386880624acbee8edd73679adfc49ec00000000000000000000000000000000000000000000000000000000000ba5a10000000000000000000000000000000000000000000000000000000000e076be","access_list":[]}},"signature":{"v":1,"r":"0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798","s":"0x64053f595237fe5f29377f48c113c40576452a7373c385d676a849c804d02144"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":8,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x2a351","to":{"Call":"0xf2f88e7ea95f2c93339484529dc7af9014657cfa"},"value":"0x0","data":"0xd37c353b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000036697066733a2f2f516d547463666873625363536b47453366324c633167517274394241415661464d6958586b353646316a64676d692f000000000000000000000000000000000000000000000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":0,"r":"0xee56a183c013a6901e9a309a449186118cd7c5cdd7487d6fa74257a31c1ef534","s":"0x6a5adba439ad3423a8c2a24ff60eb4efa897284dba946ad8ac025dd12063843b"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":7,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x1e4b0","to":"Create","value":"0x0","data":"0x608060405234801561000f575f80fd5b506101438061001d5f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c80632e64cec1146100385780636057361d14610056575b5f80fd5b610040610072565b60405161004d919061009b565b60405180910390f35b610070600480360381019061006b91906100e2565b61007a565b005b5f8054905090565b805f8190555050565b5f819050919050565b61009581610083565b82525050565b5f6020820190506100ae5f83018461008c565b92915050565b5f80fd5b6100c181610083565b81146100cb575f80fd5b50565b5f813590506100dc816100b8565b92915050565b5f602082840312156100f7576100f66100b4565b5b5f610104848285016100ce565b9150509291505056fea26469706673582212207ca8a77a375aff548bc76892f6b2093ea5bec72e34f6638bcd6bc43f620679bc64736f6c63430008160033","access_list":[]}},"signature":{"v":1,"r":"0x8f822b9f11612d0ad65c31c03168f13c3be44615b3d99edfa744e367241e65b0","s":"0x178c11d68167aace32216f8a2163e6087d996b73c73c606e3e682d80cf5b678f"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":3,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x31752","to":{"Call":"0xd2c3cbb943fed0cfc8389b14a3f6df518fd46346"},"value":"0xb1a2bc2ec50000","data":"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000065a970bc00000000000000000000000000000000000000000000000000000000000000020b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000b1a2bc2ec500000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000b1a2bc2ec500000000000000000000000000000000000000000000000000000000000b00aa1f0400000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002b0011e559da84dde3f841e22dc33f3adbf184d84a0000642a99837850543e223c134687f0c2b7e059873047000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":1,"r":"0xa114a8306dc24ae55eabdb8693342bb96d38ec5e02bfcf49258d4fe1585142c1","s":"0x1431ab11ed548dd466edc5e759a3bec24f3ae07620f57d858fb77c9b246ce23a"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":49,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x9f96c","to":{"Call":"0x5cbfccd27db8a3981fe9965b0de59d436b2bd8b9"},"value":"0x13c3777bf34ffb","data":"0xac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000164883164560000000000000000000000000011e559da84dde3f841e22dc33f3adbf184d84a0000000000000000000000002a99837850543e223c134687f0c2b7e05987304700000000000000000000000000000000000000000000000000000000000001f4fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdbb56fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdff620000000000000000000000000000000000000000000000000013c3777bf34ffb000000000000000000000000000000000000000000000000000000018e3ea11800000000000000000000000000000000000000000000000000139ae99228cb98000000000000000000000000000000000000000000000000000000018bb4e1fb000000000000000000000000a29b384a523729bc9e076013fa035ce9c2544cbc0000000000000000000000000000000000000000000000000000000065a970bc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a00000000000000000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":1,"r":"0x689068e5ae1aa38507a8d58a8a7a2c93435bf79de56285b7579f5be542c2d76","s":"0x31eda5de43d522209ac8a01bd73e6c3c1c2e4b7a71df1671e683c8e78aa6f5dd"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":10,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x2a351","to":{"Call":"0x2fcc2e44ff836fbf5c3d7e9c2ebdf3b1509cf4f3"},"value":"0x0","data":"0xd37c353b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000036697066733a2f2f516d62507a4d336645634561365270424c4765694d686e4467734d4c7347447531334263324a6b514d6e77564c482f000000000000000000000000000000000000000000000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":1,"r":"0x7f1f660b98f4600538e0c59b2eda352bce86a8229e4c32a7e5ff36373b44afb6","s":"0xd74d693dfd28bb0a611d34f5d38c1c5350aaa07a92890d065cf8705f90fd44f"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":3,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x7e0c3","to":{"Call":"0x5cbfccd27db8a3981fe9965b0de59d436b2bd8b9"},"value":"0x66dea16dd4bad73","data":"0xac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000164883164560000000000000000000000000011e559da84dde3f841e22dc33f3adbf184d84a000000000000000000000000d69d3e64d71844bbdda51cd7f23ed3631e9fac490000000000000000000000000000000000000000000000000000000000002710fffffffffffffffffffffffffffffffffffffffffffffffffffffffffff2766000000000000000000000000000000000000000000000000000000000000d89a0000000000000000000000000000000000000000000000000066dea16dd4bad73000000000000000000000000000000000000000000000046791fc84e07cff5100000000000000000000000000000000000000000000000000669d0a34d4952160000000000000000000000000000000000000000000000464bf6fe6f905302050000000000000000000000003da1db2cfab5f12239ee5ed0c84112a3ac6ed14b0000000000000000000000000000000000000000000000000000000065a970bc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a00000000000000000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":0,"r":"0xeb181f0b30e077e595db6b4141e51e31fc77ad6050fee4b93c714e679db5ed40","s":"0x7e8dadd2fd476a3da2163f553402c97fbacbf621ac35680bca4cde75752f5cd2"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":7,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x1e4b0","to":"Create","value":"0x0","data":"0x608060405234801561000f575f80fd5b506101438061001d5f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c80632e64cec1146100385780636057361d14610056575b5f80fd5b610040610072565b60405161004d919061009b565b60405180910390f35b610070600480360381019061006b91906100e2565b61007a565b005b5f8054905090565b805f8190555050565b5f819050919050565b61009581610083565b82525050565b5f6020820190506100ae5f83018461008c565b92915050565b5f80fd5b6100c181610083565b81146100cb575f80fd5b50565b5f813590506100dc816100b8565b92915050565b5f602082840312156100f7576100f66100b4565b5b5f610104848285016100ce565b9150509291505056fea2646970667358221220175b5ff5925b348b9f880264a1038aba4c999696f4387cf13a5ccdd35467fb6664736f6c63430008160033","access_list":[]}},"signature":{"v":0,"r":"0x92186532daaee1105b32dc5d9f6a08af177fa70a1c82b78f4f300f7883bc05da","s":"0x60446c625c010ec561f7e58ce5c9e5397552c43c47cb21360dda05084d38a44d"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":4,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x1e4a4","to":"Create","value":"0x0","data":"0x608060405234801561000f575f80fd5b506101438061001d5f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c80632e64cec1146100385780636057361d14610056575b5f80fd5b610040610072565b60405161004d919061009b565b60405180910390f35b610070600480360381019061006b91906100e2565b61007a565b005b5f8054905090565b805f8190555050565b5f819050919050565b61009581610083565b82525050565b5f6020820190506100ae5f83018461008c565b92915050565b5f80fd5b6100c181610083565b81146100cb575f80fd5b50565b5f813590506100dc816100b8565b92915050565b5f602082840312156100f7576100f66100b4565b5b5f610104848285016100ce565b9150509291505056fea2646970667358221220af7008041a150a4ff43e9709ce67654cf19205ed004c4b1fe1500399ade56b9b64736f6c63430008170033","access_list":[]}},"signature":{"v":0,"r":"0x258ee024e15f77051480ac80950a73fa01a63ad3177d4ec7c95777799bf63f03","s":"0x40153d47a283de30db685aa6ae382f55415bd22733c115c6dc089fc8a5115bd7"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":5,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0xf34f","to":{"Call":"0xd69d3e64d71844bbdda51cd7f23ed3631e9fac49"},"value":"0x0","data":"0x095ea7b30000000000000000000000005cbfccd27db8a3981fe9965b0de59d436b2bd8b9ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff","access_list":[]}},"signature":{"v":1,"r":"0x6262be6fbbf8faabf3dade6f0ed9db7c0c640a5c4635e69f917858c9fbb83377","s":"0x4d18809f51c9f0ac05b6d11c7a9fad3cc188737a63e7c27dfc37c9dc2bf1fb33"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":34,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x2cae4","to":{"Call":"0xd2c3cbb943fed0cfc8389b14a3f6df518fd46346"},"value":"0x11c37937e080000","data":"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000065a970bc00000000000000000000000000000000000000000000000000000000000000020b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000011c37937e08000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000011c37937e080000000000000000000000000000000000000000000000000000000000119a5a1d9e00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002b0011e559da84dde3f841e22dc33f3adbf184d84a0000642a99837850543e223c134687f0c2b7e059873047000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":1,"r":"0x229795aac8a953809780d882cef11783aa775a348e13e13937990c15fbb0c4e","s":"0x1071aba3e0a1a1f91dd2d4aaacd4077c292cfbaf5dbb77e5290b226e9b06708a"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":0,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x18e05","to":{"Call":"0x1670080000000000000000000000000000000001"},"value":"0x26c6036ae68a20","data":"0x33bcd0cc0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000085841072598236162b9a8fff9f254a9e20e9cc2d0000000000000000000000000000000000000000000000000000000000028c60000000000000000000000000000000000000000000000000000000000000426800000000000000000000000085841072598236162b9a8fff9f254a9e20e9cc2d00000000000000000000000085841072598236162b9a8fff9f254a9e20e9cc2d00000000000000000000000085841072598236162b9a8fff9f254a9e20e9cc2d000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000033f10fb258a2000000000000000000000000000000000000000000000000000000000000222e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":1,"r":"0x69c02aca8c3ebb8f3ab9c3ec247538acc3c600d4a80b155a1a97f76124c3e9be","s":"0x71fe7065af839d2e7722430d162b806bec0ff65f3a7d70e39a0b9e8deb163a47"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":9,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x1c71f","to":{"Call":"0x5d04bc3ddd8bcbdf3ff71ab39e62287ca185ae3e"},"value":"0x38d7ea4c68000","data":"0x1249c58b","access_list":[]}},"signature":{"v":0,"r":"0xfb9511460ab049660f2481840ed862642528247687800f9f00fb2b7b73a2c8bf","s":"0x2c38d48b31721f3893228be8705e0b34b5774011a5fdb54f3d3a18560a3955c5"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":3,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0xf34f","to":{"Call":"0xd69d3e64d71844bbdda51cd7f23ed3631e9fac49"},"value":"0x0","data":"0x095ea7b30000000000000000000000005cbfccd27db8a3981fe9965b0de59d436b2bd8b9ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff","access_list":[]}},"signature":{"v":1,"r":"0x4c2a32a6a6747c871566ecf4415255fd94ee3c2f648f46b8ea15cb509ffafed8","s":"0x58c53a01ff12fd74f21f00fea903753dd632c0c6a5763ccf680f9e9c8ca242e9"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":18,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0xfc55","to":{"Call":"0x5535b9ff2aa1a63b87921599850cb942f813323b"},"value":"0x0","data":"0xa9059cbb000000000000000000000000eb15859af4dc37738f32e8bb468eb1ffde5bd7a700000000000000000000000000000000000000000000021e19e0c9bab2400000","access_list":[]}},"signature":{"v":1,"r":"0xac3db1534cf8dad72a8cb063c3fea0d1d0f48d27ab0c7f8eb16054e9324395f","s":"0x458c8ac58e9f6d94dc64d59747b56cbfeef3b2db7ba0db8ccadc049d84069337"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":13,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0xd105","to":{"Call":"0xae2c46ddb314b9ba743c6dee4878f151881333d9"},"value":"0x0","data":"0x095ea7b3000000000000000000000000fde807b7c79f69f22622acb73db5b59654e115b60000000000000000000000000000000000000000000000000000000000402a73","access_list":[]}},"signature":{"v":1,"r":"0x907171397fefd07536584acf07fa05e113b7887964aa802761b7c8b161fe1bcd","s":"0x3be9419669fc93e94f68f3cd67edb941b0d6257a63ef860e9bb44eb2311d105"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":2,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x66a97","to":{"Call":"0x1670080000000000000000000000000000000001"},"value":"0x0","data":"0x0138240800000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001d764000000000000000000000000d209f6fbdce2462f3063321be3b96b481b44858100000000000000000000000000000000000000000000000000000000000042680000000000000000000000000000000000000000000000000000000000028c60000000000000000000000000d209f6fbdce2462f3063321be3b96b481b448581000000000000000000000000d209f6fbdce2462f3063321be3b96b481b448581000000000000000000000000d209f6fbdce2462f3063321be3b96b481b4485810000000000000000000000000000000000000000000000000011c37937e080000000000000000000000000000000000000000000000000000004cbd15e801ba000000000000000000000000000000000000000000000000000000000000222e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000167008000000000000000000000000000001000100000000000000000000000000000000000000000000000000000000000ba59a000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000000000000000000000000000896f90893b90214f90211a04d338534c32c08dad0c101fe1798d1203edb20b2549468d1a3bb35237f5b76d9a04f2a94632c3c16f5c0f122731eb2beb951b7acf3249414e7a7ccd04597d9c746a0685df84299cc6f9ac64b2f49e2568d02f0c77aad28ee5b664748192e11f007a4a0aee90207fdca1d5e1ea19b61c3ae4b24d7e1aa4b7d283e66029e191e709c864ba0f197a203c989c02cd7f150f0596333d98079e4db2975a53cff67892497c208fda06303c9fce964d57aefb2bc0933477768fd48159deae37fac7138c2a3b8d51cc4a0179b035da2f9fdbb8bcf0ecafefb8d192ad5461aa146c6a690d20f1aa2089cd2a03e7b4458cbef3a6450004d40e0405a5571d030aa726d3a3da927d2a0ad1ba2fca0a4fffc6f869f6fc1bd00e64717df0035bee73e053c8ffa2765fbe2b27e86b3cfa06a1c14b1afbc465cc1553022116dde190b75cb92f8934074d2d046819d96dc00a0ec5386f3963a273e86060b6331ffc6c80a0df3a62e80193e6b9e66fe3262a9a6a066b2ff83824da5d831dda93c61a86c1b7a47492e558812878fcac7eacc1fa2a3a0e956b036b9570e798ddd15d9addf05a9f4e6a59bb3fd390ee86af1ba59632399a07ba682d91356cbb366314dab761dc97f6b53408562220b6233d2d7548d8522c4a0d9193d56e31ed7c50961592f21100febfcad45483fdd936d90ea8d8a2373cd31a0c9c8646daffe4b5fd7034deb172d4395462b3d72496a694c932b2908d1b2fbf780b90214f90211a0696c733cbbb18499e545004214dcb110a35c6acd9ce77461f9ab4f2f30311203a002b91aaa1ce363e25b95e77273990878898c9b100f038b51eafbf1f96baeae89a0984508740e4512154619a4274f22b5cdee7eb6e4faae6ed5741d4b6027390152a06e3344335cd57cda7affb56155f126c60d2fe34b02e9ce8d2be7f1f88ab98a10a0b3254e9ef461f192c9044a65d0e60b304142649ad2057c684f1f26acdae63230a00a65ce7f2398a7a71eb158670acfc4f349e0152a5020d6dc279c4447ef8e9793a001049d0c5ebac806f9189934025ed3820c83fc7ccb4a67387a46fc53d0e9e3b8a0f4e9edeb76a7f2d1e1f70c315cfd2c642c48a4b2e53d6f9fdac1f26d1ad3f60aa03059144b248f828a560a3fec36da447b4f22cc81910db5690d5587844cbd7948a010a11769e51f30f523001bbdcd72370d8e2eea566889ccdd02cde1e3a7beb1ada010c9a764788bf1b6891589350c4f38847832992fe94351fb212d6b33baf0a283a0c4da0adc3b7b82324a20d15760487a79562cbb0f406bc8559e1deab5cee3f260a0e6a50d75e9499e7ba4bf0ed5b45ccee2935088aed62450406228c84c3c317b22a0c206a8a4627daf678da0710496c28dfb2a09e2ed9d10c4d78dcd992a733b8e4aa00e7a51b5c5a86483925750dc1eb0b6b2e597d59ca5e402a4bcd3010fcbb4b0bfa0f565212ee1fdbbc53a29832495f71ac368c06c1b2988d64fd6588dd69ddd020880b90214f90211a0094855f0e01800ab91e234bd4475b26cee6c4b8bafd93be4890bcbe6aa929819a0091bb2ef5ab4862381362ffb0378c9d30e05eae96211f8527e3e255747886d33a0faaf2e875df5fdd723e58919ed9caf447dc6c0248a25f8fd0cb148e04215872ba0db91cc17d08bd087d67a236984c2e12cc9ddea4862a1a21a13f478dc6c80d855a0733fddac882f5a7fce648478daf566988aeefc82a668e4fc1857d98199b01b66a0db33be24d2f3f3df19167f1a08dceb543d47e4530f334eb73bd10fad7e945cfaa0de73de062cab691c79044a024d499c53ef2306afb3955781bb4791d3f95460f0a0f9e7845a7fc516fb1fb3697045addcc638cf084e8ac5810ac70022a4c7c670c7a0a0c2f93c0c5718871c846ca47f449833f131610146ff59e1d943aed70eb79712a04ce6d5d782d3d61cb9c3160ceadcf377384c31a49ed0ac427e26cbf04691586ba0a49205927873adfa81c1dfc05ce22459e3e9ad7c7aa43111d3238412aa70de5fa095fcb28f0fa956ba3236f7cb2bf5f0240ce26671bd2805bd42f9739ccb027814a060d982e4f8d08a0ac23f2f05436d086fa2491a1927162bb2cc02059fcc421090a0612c90d3cd9d84e9baded563e523cef2fbe63fe7713fb666628e6123236e5313a02cbc5e9b1fee2358f2b3a12049778e5c7f8589d1dd8077a98fe549c2969fbdbda0d81256248ec40a800150815c2880135654a428b67665f7d1a2767736e371536f80b901d4f901d1a06e6a5be3912d1e57cd7e62c8cd26bac69f85d985238bdee92dc3d1e76217f021a074e4d0d470f4e14d7039a8bf622f28d71727b857815a26d9116b612e0ad6062580a0dd3b2dd3e45de43392021d9b6711ae51f0ddce380706cc873854eb79fa9702c1a0e6c2420f1bbca66b295de1b50c8098283df205e36b21cbd1fe28bb8f5d478a84a0e08af052acaad51a6ca56e8eab502daaaf1750992c8f75dce02e4064cd6e67c5a07da506423017a0796f02c910edc631dc0efb8a5bcc8f4b71b2a4c7d53ba5afb6a0ef5fdc8453a143c403bb1db38026bb78edfd4e86f4c4af1c0a7d2712c21c573ba05b392046508ce0894d57c3e44579eb71ff03a73d06b7e39894aa0dc39b9cba09a0dfcec8f3f4d10129f4d14843f3c957f2b16d1e262efd72b9babcf997d280527fa070ce02729dbe2f92a5f612e3602f020ed7f7b88c7f288e3112128d53505c6848a04f94d5e5a1a910d400f378e3dadf2cc07c0aa2e637d86b09922a0f8477f8bc5a80a012afb69e9d1de641d4d4f91fe240d7104e594c15a282f51097771908b92153b7a03ef659dcc44ebd4fd09a9d4f98ffe749a41d8b1a4bfead679dcfa6e92c25b2dda0af80c4e08ac9185959a41fe015532674a0b1b030735d6ba8991e59a7b617c53e80b853f851808080a00224e1fdf1ab331b3134156b057cb59d9bc1428229a324ccc7a1261676e7557c80808080808080a0e6e623c65732560b5e311649960f5ae5c9d9c93da90f3f41b98bc3f52a5c50798080808080a1e09e3bf3e72547899f614325047fbbd95aa7d3089f0a4fe8da9293a0b34e5ec901000000000000000000000000000000000000000000000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":0,"r":"0xf622a174fc4803fd9c5f3581671487e0e1ccbec5c7128f231252a81364ab772d","s":"0x71cadc95edcfd863e0192cebee1b867212b5662f75ddc3d11e8d2450bb1c5f4"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":2,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0xc989","to":{"Call":"0xd69d3e64d71844bbdda51cd7f23ed3631e9fac49"},"value":"0x0","data":"0x095ea7b3000000000000000000000000fde807b7c79f69f22622acb73db5b59654e115b6000000000000000000000000000000000000000000000000d02ab486cedc0000","access_list":[]}},"signature":{"v":0,"r":"0x374cacab8e656e89b5726c0a62b0184a9922e58b625abfe442333affef9cb5d2","s":"0x3fc455c2876bb3c5c6c33550459e6a5da56a444327577ffea74851bf5554e3da"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":6,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x7e07b","to":{"Call":"0x5cbfccd27db8a3981fe9965b0de59d436b2bd8b9"},"value":"0x221b262dd8000","data":"0xac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000164883164560000000000000000000000000011e559da84dde3f841e22dc33f3adbf184d84a000000000000000000000000d69d3e64d71844bbdda51cd7f23ed3631e9fac490000000000000000000000000000000000000000000000000000000000002710fffffffffffffffffffffffffffffffffffffffffffffffffffffffffff2766000000000000000000000000000000000000000000000000000000000000d89a0000000000000000000000000000000000000000000000000000221b262dd8000000000000000000000000000000000000000000000000000175d77c37d3e32d00000000000000000000000000000000000000000000000000002205671c88644000000000000000000000000000000000000000000000000174e7ed3b949b396000000000000000000000000b56d486406d4c8e7af2da8b79eab680309f7b0030000000000000000000000000000000000000000000000000000000065a970bc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a00000000000000000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":1,"r":"0xe969a2e7c314fc6a369e72b2ce5bd99340f81072d5ef42cec35cc7510d4f1f06","s":"0x75b5f0a869c54fd473023cc362edb2dc1ae41868a11e4c29efde300fd9ae6eb"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":3,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x1e4b0","to":"Create","value":"0x0","data":"0x608060405234801561000f575f80fd5b506101438061001d5f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c80632e64cec1146100385780636057361d14610056575b5f80fd5b610040610072565b60405161004d919061009b565b60405180910390f35b610070600480360381019061006b91906100e2565b61007a565b005b5f8054905090565b805f8190555050565b5f819050919050565b61009581610083565b82525050565b5f6020820190506100ae5f83018461008c565b92915050565b5f80fd5b6100c181610083565b81146100cb575f80fd5b50565b5f813590506100dc816100b8565b92915050565b5f602082840312156100f7576100f66100b4565b5b5f610104848285016100ce565b9150509291505056fea26469706673582212207ca8a77a375aff548bc76892f6b2093ea5bec72e34f6638bcd6bc43f620679bc64736f6c63430008160033","access_list":[]}},"signature":{"v":1,"r":"0x8faabd527d388ef1a925df7b6cda79a8db15fa4841c7b65cefb9feb79bc0c191","s":"0x6da937d631650c8f0583d449c5a7d963a0868dc24eb86f31895111bf6b77fcec"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":1,"max_priority_fee_per_gas":"0x59682f00","max_fee_per_gas":"0x59682f01","gas_limit":"0x47eb9","to":{"Call":"0xd2c3cbb943fed0cfc8389b14a3f6df518fd46346"},"value":"0xb1a2bc2ec500000","data":"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000065a970bc00000000000000000000000000000000000000000000000000000000000000030b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000b1a2bc2ec5000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000006a94d74f4300000000000000000000000000000000000000000000000000000000000000132060300000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002b0011e559da84dde3f841e22dc33f3adbf184d84a0001f4ae2c46ddb314b9ba743c6dee4878f151881333d9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000470de4df82000000000000000000000000000000000000000000000000000000000000000cbd3eb00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002b0011e559da84dde3f841e22dc33f3adbf184d84a000bb8ae2c46ddb314b9ba743c6dee4878f151881333d9000000000000000000000000000000000000000000","access_list":[]}},"signature":{"v":0,"r":"0x400e80dc05b0d0500951513bf209257e00c71b28d4e777b9f1dd4dae7f898489","s":"0x7a8fa0a5ebcc6d924a6c1875efdf7242786ac03e1a84101eeb833458608742d7"}},{"essence":{"Eip1559":{"chain_id":167008,"nonce":802,"max_priority_fee_per_gas":"0x186a0","max_fee_per_gas":"0x186a1","gas_limit":"0x55200","to":{"Call":"0xbfcfd6fb89c1fdd0d87c3d24dd8fc1d371203651"},"value":"0x0","data":"0x783cf332000000000000000000000000000000000000000000000000000000395bb93400","access_list":[]}},"signature":{"v":0,"r":"0xcbaea2f53ed121fa6d314add4cb619dd971e0578bec2b1c9d91912d54f7bac7a","s":"0x6c7819f144ff6caba3c31ed383fde2c6f8eed40a3dfbff5183f00fb2095ff208"}}]
        "#;
        let rust_root = rust_mtp_root(txs).unwrap();
        let go_root = go_mtp_root(txs).unwrap();

        assert_eq!(rust_root.rlps.len(), go_root.rlps.len());
        println!("rust_root.rlps[0]: {}", rust_root.rlps[0]);
        println!("go_root.rlps[0]: {}", go_root.rlps[0]);
        println!("rust_root.root: {}", rust_root.root);
        println!("go_root.root: {}", go_root.root);
        assert_eq!(rust_root.root, go_root.root);
    }
}
